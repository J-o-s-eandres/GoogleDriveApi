<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÅ Google Drive Manager</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Tu CSS personalizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand nav-brand" href="#">
                <i class="bi bi-google-drive"></i>Drive Manager Pro
            </a>
            
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <span class="status-indicator status-online"></span>
                    <span class="text-muted small" id="connectionStatus">Conectando...</span>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="toggleTheme()">
                    <i class="bi bi-moon-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="hero-section">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-5 fw-bold mb-3">‚ú® Gesti√≥n Avanzada de Google Drive</h1>
                        <p class="lead text-muted mb-4">
                            Controla los permisos de tus archivos de Google Drive de manera profesional. 
                            Interfaz intuitiva, r√°pida y segura para gestionar accesos en tiempo real.
                        </p>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge-feature bg-primary text-white">
                                <i class="bi bi-eye me-1"></i> Visualizaci√≥n en tiempo real
                            </span>
                            <span class="badge-feature bg-success text-white">
                                <i class="bi bi-person-plus me-1"></i> Otorgar permisos
                            </span>
                            <span class="badge-feature bg-danger text-white">
                                <i class="bi bi-person-x me-1"></i> Revocar accesos
                            </span>
                            <span class="badge-feature bg-warning text-white">
                                <i class="bi bi-shield-check me-1"></i> Seguridad garantizada
                            </span>
                        </div>
                    </div>
                    <div class="col-lg-4 text-center d-none d-lg-block">
                        <i class="bi bi-google-drive display-1 text-primary opacity-25" style="animation: float 4s ease-in-out infinite;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Toast para mensajes -->
            <div class="toast-container position-fixed top-0 end-0 p-3">
                <div id="liveToast" class="toast custom-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="bi bi-info-circle me-2 text-primary"></i>
                        <strong class="me-auto">Notificaci√≥n del Sistema</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body" id="toastMessage">
                        Mensaje aqu√≠
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index: 1050;">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-muted fw-medium" id="loadingText">Procesando tu solicitud...</p>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Panel izquierdo: Ver permisos y gesti√≥n -->
                <div class="col-lg-8">
                    <!-- Card: Ver permisos -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-search me-2"></i>üîç Explorar Permisos del Archivo
                            </div>
                            <span class="badge bg-info rounded-pill px-3 py-2" id="permissionsCount">0 permisos</span>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <label for="fileId" class="form-label fw-medium mb-2">
                                        <i class="bi bi-file-earmark-text me-1"></i>ID del Archivo de Google Drive
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-hash text-primary"></i>
                                        </span>
                                        <input type="text" class="form-control" id="fileId" 
                                               placeholder="Ej: 1MBbESCRgAS3WYPZfbyyyY46e6da6dgf5">
                                    </div>
                                    <div class="form-text text-muted mt-2">
                                        <i class="bi bi-info-circle me-1"></i>Pega el ID del archivo que deseas gestionar
                                    </div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="d-grid gap-2 w-100">
                                        <button class="btn btn-primary action-btn" onclick="getPermissions()">
                                            <i class="bi bi-eye me-2"></i>Ver Permisos
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="getFileInfo()">
                                            <i class="bi bi-info-circle me-2"></i>Informaci√≥n
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n del archivo -->
                            <div class="alert alert-light border d-none mb-4" id="fileInfoCard">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 fw-bold" id="fileName">
                                            <i class="bi bi-file-earmark me-2"></i>Nombre del archivo
                                        </h6>
                                        <p class="mb-1 small text-muted" id="fileDetails">
                                            <i class="bi bi-clock-history me-1"></i>Detalles del archivo...
                                        </p>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="hideFileInfo()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Lista de permisos -->
                            <div id="permissionsContainer">
                                <div class="empty-state" id="emptyState">
                                    <i class="bi bi-people"></i>
                                    <h5 class="text-muted fw-bold">No hay permisos para mostrar</h5>
                                    <p class="text-muted small">Ingresa un ID de archivo y haz clic en "Ver Permisos"</p>
                                </div>
                                
                                <div class="table-responsive d-none" id="permissionsTable">
                                    <table class="table table-permissions">
                                        <thead>
                                            <tr>
                                                <th><i class="bi bi-person me-1"></i> Usuario</th>
                                                <th><i class="bi bi-tag me-1"></i> Tipo</th>
                                                <th><i class="bi bi-shield me-1"></i> Rol</th>
                                                <th><i class="bi bi-key me-1"></i> ID del Permiso</th>
                                                <th><i class="bi bi-gear me-1"></i> Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="permissionsList">
                                            <!-- Las filas se insertan aqu√≠ con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card: Eliminar permiso -->
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-person-x me-2"></i>üóëÔ∏è Eliminar Permiso
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="deleteValue" class="form-label fw-medium" id="deleteLabel">
                                        <i class="bi bi-envelope me-1"></i>Email del usuario
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-at text-primary"></i>
                                        </span>
                                        <input type="text" class="form-control" id="deleteValue" 
                                               placeholder="usuario@gmail.com">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="deleteType" class="form-label fw-medium">
                                        <i class="bi bi-filter me-1"></i>Tipo de eliminaci√≥n
                                    </label>
                                    <select class="form-select" id="deleteType" onchange="toggleDeleteInput()">
                                        <option value="email">Por Email</option>
                                        <option value="id">Por ID del Permiso</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-danger action-btn w-100" onclick="deletePermission()">
                                        <i class="bi bi-trash me-2"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel derecho: Otorgar permiso -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-person-plus me-2"></i>üéÅ Otorgar Nuevo Permiso
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="grantFileId" class="form-label fw-medium">
                                    <i class="bi bi-file-earmark me-1"></i>ID del Archivo
                                </label>
                                <input type="text" class="form-control" id="grantFileId" 
                                       placeholder="ID del archivo (opcional)">
                                <div class="form-text text-muted mt-1">
                                    <i class="bi bi-lightbulb me-1"></i>Deja vac√≠o para usar el mismo archivo
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="permType" class="form-label fw-medium">
                                    <i class="bi bi-diagram-3 me-1"></i>Tipo de Permiso
                                </label>
                                <select class="form-select" id="permType">
                                    <option value="user">üë§ Usuario Individual</option>
                                    <option value="group">üë• Grupo de Google</option>
                                    <option value="domain">üåê Dominio Completo</option>
                                    <option value="anyone">üîó Cualquiera con el Link</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="permValue" class="form-label fw-medium" id="valueLabel">
                                    <i class="bi bi-envelope me-1"></i>Email del Usuario
                                </label>
                                <input type="text" class="form-control" id="permValue" 
                                       placeholder="usuario@gmail.com">
                            </div>
                            
                            <div class="mb-3">
                                <label for="permRole" class="form-label fw-medium">
                                    <i class="bi bi-award me-1"></i>Rol del Permiso
                                </label>
                                <select class="form-select" id="permRole">
                                    <option value="reader">üìñ Lector (Solo lectura)</option>
                                    <option value="writer">‚úèÔ∏è Editor (Puede modificar)</option>
                                    <option value="Commenter">üí¨ Comentarista (Puede comentar)</option>
                                    <option value="owner">üëë Propietario (Acceso completo)</option>
                                </select>
                            </div>
                            
                            <div class="d-grid mb-4">
                                <button class="btn btn-success action-btn py-2" onclick="grantPermission()">
                                    <i class="bi bi-check-circle me-2"></i>Otorgar Permiso
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="border-bottom pb-2 fw-bold">
                                    <i class="bi bi-list-check me-2"></i>Roles Disponibles
                                </h6>
                                <div class="row g-2 mt-2">
                                    <div class="col-6">
                                        <div class="role-card">
                                            <div class="badge-reader permission-badge mb-2">Lector</div>
                                            <p class="small text-muted mb-0">Solo puede ver el contenido</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="role-card">
                                            <div class="badge-writer permission-badge mb-2">Editor</div>
                                            <p class="small text-muted mb-0">Puede editar el archivo</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="role-card">
                                            <div class="badge-commentor permission-badge mb-2">Comentarista</div>
                                            <p class="small text-muted mb-0">Puede agregar comentarios</p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="role-card">
                                            <div class="badge-owner permission-badge mb-2">Propietario</div>
                                            <p class="small text-muted mb-0">Control total del archivo</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3">
                        <i class="bi bi-google-drive me-2"></i>Google Drive Manager Pro
                    </h6>
                    <p class="text-muted small">
                        Herramienta profesional para gesti√≥n de permisos en Google Drive. 
                        Interfaz moderna, segura y eficiente para administrar accesos a tus archivos.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted small mb-0">
                        <i class="bi bi-code-slash me-1"></i> Desarrollado por JGM
                        <br>
                        <span id="currentYear">¬© 2024</span>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>

        // Inicializar toast
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        
        // Variables globales
        let currentFileId = '';
        let currentPermissions = [];
        
        // Actualizar a√±o en el footer
        document.getElementById('currentYear').textContent = `¬© ${new Date().getFullYear()}`;
        
        // Mostrar toast de mensaje
        function showToast(message, type = 'info') {
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toastEl.querySelector('.toast-header');
            const icon = toastHeader.querySelector('i');
            
            toastMessage.textContent = message;
            
            // Cambiar color seg√∫n tipo
            icon.className = `bi me-2`;
            switch(type) {
                case 'success':
                    icon.className += ' bi-check-circle-fill text-success';
                    break;
                case 'error':
                    icon.className += ' bi-x-circle-fill text-danger';
                    break;
                case 'warning':
                    icon.className += ' bi-exclamation-triangle-fill text-warning';
                    break;
                default:
                    icon.className += ' bi-info-circle-fill text-primary';
            }
            
            toast.show();
        }
        
        // Mostrar/ocultar loading
        function showLoading(text = 'Procesando...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('d-none');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('d-none');
        }
        
        // Toggle tema oscuro/claro
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            
            // Guardar preferencia
            localStorage.setItem('theme', newTheme);
            
            // Cambiar √≠cono
            const icon = document.querySelector('[onclick="toggleTheme()"] i');
            icon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
            
            showToast(`Tema ${newTheme === 'dark' ? 'oscuro' : 'claro'} activado`);
        }
        
        // Verificar estado de conexi√≥n
        async function checkConnection() {
            try {
                const response = await fetch('/api/status'); 
                const data = await response.json();
                
                const statusEl = document.getElementById('connectionStatus');
                
                if (data.credentials_valid) {
                    statusEl.innerHTML = '<span class="status-indicator status-online"></span> Conectado';
                    statusEl.className = 'small';
                } else {
                    statusEl.innerHTML = '<span class="status-indicator status-offline"></span> Sin credenciales';
                    statusEl.className = 'small text-danger';
                    showToast('‚ö†Ô∏è No se encontraron credenciales. Ejecuta primero la autenticaci√≥n.', 'warning');
                }
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="status-indicator status-offline"></span> Error de conexi√≥n';
                console.error('Error conectando a la API:', error);
            }
        }

        // Llamar al verificar conexi√≥n al cargar la p√°gina
        async function getPermissions() {
            let fileId = document.getElementById('fileId').value.trim();
            
            if (!fileId) {
                showToast('Por favor ingresa un ID de archivo', 'error');
                return;
            }
            
            currentFileId = fileId;
            showLoading('Obteniendo permisos...');
            
            try {
                console.log('üì° Iniciando solicitud de permisos...');
                
                // IMPORTANTE: Usar URL correcta seg√∫n dispositivo
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                let apiUrl;
                
                if (isMobile) {
                    // En m√≥vil, usa IP completa
                    const currentUrl = window.location.href;
                    const baseUrl = currentUrl.split('/').slice(0, 3).join('/'); // Ej: http://192.168.1.8:5000
                    apiUrl = `${baseUrl}/api/permissions/${fileId}`;
                } else {
                    // En desktop, usa ruta relativa
                    apiUrl = `/api/permissions/${fileId}`;
                }
                
                console.log(`üì° URL de API: ${apiUrl}`);
                console.log(`üìÑ ID Archivo: ${fileId}`);
                
                const response = await fetch(apiUrl);
                console.log(`üìä Status: ${response.status} ${response.statusText}`);
                console.log(`üìã Content-Type: ${response.headers.get('content-type')}`);
                
                // Verificar respuesta
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Datos recibidos:', data);
                
                if (data.error) {
                    showToast('Error: ' + data.error, 'error');
                    hideLoading();
                    return;
                }
                
                if (!data.success) {
                    showToast('Error inesperado en la respuesta', 'error');
                    hideLoading();
                    return;
                }
                
                // Actualizar contador
                document.getElementById('permissionsCount').textContent = `${data.count} permisos`;
                
                // Mostrar informaci√≥n del archivo
                document.getElementById('fileName').textContent = data.file_title;
                document.getElementById('fileDetails').textContent = `ID: ${data.file_id} ‚Ä¢ ${data.count} permisos`;
                document.getElementById('fileInfoCard').classList.remove('d-none');
                
                // Mostrar tabla de permisos
                currentPermissions = data.permissions || [];
                
                if (currentPermissions.length > 0) {
                    renderPermissionsTable(currentPermissions);
                    document.getElementById('emptyState').classList.add('d-none');
                    document.getElementById('permissionsTable').classList.remove('d-none');
                } else {
                    document.getElementById('emptyState').classList.remove('d-none');
                    document.getElementById('permissionsTable').classList.add('d-none');
                }
                
                showToast(`‚úÖ Se encontraron ${data.count} permisos`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                showToast('Error al obtener permisos: ' + error.message, 'error');
                
                // Mostrar sugerencias seg√∫n el error
                if (error.message.includes('Failed to fetch')) {
                    console.error('üîå Error de conexi√≥n. Verifica:');
                    console.error('   1. El servidor Flask est√° corriendo');
                    console.error('   2. La IP es correcta (192.168.1.8)');
                    console.error('   3. El firewall permite conexiones');
                }
                
            } finally {
                hideLoading();
            }
        }

        // Nueva funci√≥n para renderizar la tabla
        function renderPermissionsTable(permissions) {
            const tbody = document.getElementById('permissionsList');
            tbody.innerHTML = '';
            
            console.log(`üé® Renderizando ${permissions.length} permisos...`);
            
            permissions.forEach((perm, index) => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                
                // Determinar badge seg√∫n rol
                let badgeClass = 'badge-reader';
                switch(perm.role) {
                    case 'writer': badgeClass = 'badge-writer'; break;
                    case 'owner': badgeClass = 'badge-owner'; break;
                    case 'commentor': badgeClass = 'badge-commentor'; break;
                }
                
                // Avatar iniciales
                let initials = '?';
                if (perm.name) {
                    initials = perm.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                } else if (perm.email) {
                    initials = perm.email.substring(0, 2).toUpperCase();
                }
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">${initials}</div>
                            <div>
                                <div class="fw-medium">${perm.name || perm.email || 'Sin nombre'}</div>
                                <div class="small text-muted">${perm.email || perm.domain || perm.type}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark border">${perm.type}</span>
                    </td>
                    <td>
                        <span class="${badgeClass} permission-badge">${perm.role}</span>
                    </td>
                    <td>
                        <code class="small" title="${perm.id}">${perm.id.substring(0, 8)}...</code>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermissionById('${perm.id}')" title="Eliminar permiso">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log('‚úÖ Tabla renderizada correctamente');
        }
        
        // Obtener informaci√≥n del archivo
        async function getFileInfo() {
            const fileId = document.getElementById('fileId').value.trim();
            
            if (!fileId) {
                showToast('Por favor ingresa un ID de archivo', 'error');
                return;
            }
            
            showLoading('Obteniendo informaci√≥n...');
            
            try {
                const response = await fetch(`/api/file/${fileId}`);
                // ... resto del c√≥digo igual ...
            } catch (error) {
                showToast('Error al obtener informaci√≥n: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Otorgar permiso
        async function grantPermission() {
            let fileId = document.getElementById('grantFileId').value.trim();
            
            // Si no se especifica, usar el mismo de arriba
            if (!fileId && currentFileId) {
                fileId = currentFileId;
            } else if (!fileId) {
                showToast('Por favor ingresa un ID de archivo', 'error');
                return;
            }
            
            const type = document.getElementById('permType').value;
            const value = document.getElementById('permValue').value.trim();
            const role = document.getElementById('permRole').value;
            
            // Validaciones...
            
            showLoading('Otorgando permiso...');
            
            try {
                const response = await fetch('/api/permissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        type: type,
                        value: value,
                        role: role
                    })
                });
                // ... resto del c√≥digo igual ...
            } catch (error) {
                showToast('Error al otorgar permiso: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Funci√≥n para eliminar permiso desde el bot√≥n de basura en la tabla
        async function deletePermissionById(permissionId) {
            let fileId = currentFileId;
            
            if (!fileId) {
                showToast('Primero busca un archivo para obtener su ID', 'error');
                return;
            }
            
            if (!permissionId) {
                showToast('ID de permiso no v√°lido', 'error');
                return;
            }
            
            // Confirmar eliminaci√≥n
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este permiso?')) {
                return;
            }
            
            showLoading('Eliminando permiso...');
            
            try {
                let url = `/api/permissions/${fileId}/${permissionId}`;
                
                console.log(`üóëÔ∏è Eliminando permiso ID: ${permissionId} del archivo: ${fileId}`);
                console.log(`üåê URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Permiso eliminado correctamente', 'success');
                    
                    // Actualizar la lista de permisos inmediatamente
                    await getPermissions();
                    
                } else {
                    showToast('Error: ' + (data.error || 'Error desconocido'), 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error al eliminar permiso:', error);
                showToast('Error al eliminar permiso: ' + error.message, 'error');
                
                // Mensaje espec√≠fico para errores de conexi√≥n
                if (error.message.includes('Failed to fetch')) {
                    showToast('Error de conexi√≥n. Verifica que el servidor est√© activo.', 'error');
                }
                
            } finally {
                hideLoading();
            }
        }

        // Funci√≥n para eliminar permiso desde el FORMULARIO
        async function deletePermission() {
            // Verificar que hay un archivo seleccionado
            if (!currentFileId) {
                showToast('‚ö†Ô∏è Primero busca un archivo para obtener su ID', 'warning');
                return;
            }
            
            const deleteType = document.getElementById('deleteType').value;
            const deleteValue = document.getElementById('deleteValue').value.trim();
            
            // Validar entrada
            if (!deleteValue) {
                if (deleteType === 'email') {
                    showToast('‚úã Por favor ingresa un email', 'warning');
                } else {
                    showToast('‚úã Por favor ingresa un ID de permiso', 'warning');
                }
                return;
            }
            
            // Confirmar eliminaci√≥n
            let confirmMessage = deleteType === 'email' 
                ? `¬øEst√°s seguro de eliminar el permiso para "${deleteValue}"?`
                : `¬øEst√°s seguro de eliminar el permiso con ID "${deleteValue.substring(0, 8)}..."?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showLoading('üóëÔ∏è Eliminando permiso...');
            
            try {
                let url, body;
                
                if (deleteType === 'email') {
                    // Eliminar por EMAIL
                    url = `/api/permissions/${currentFileId}/email`;
                    body = JSON.stringify({ 
                        email: deleteValue,
                        file_id: currentFileId 
                    });
                } else {
                    // Eliminar por ID del permiso (igual que la tabla)
                    url = `/api/permissions/${currentFileId}/${deleteValue}`;
                    body = null;
                }
                
                console.log(`üì° Enviando solicitud DELETE a: ${url}`);
                console.log(`üì¶ Datos:`, body);
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: body ? { 
                        'Content-Type': 'application/json' 
                    } : {},
                    body: body
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `Error HTTP ${response.status}`);
                }
                
                if (data.success) {
                    showToast('‚úÖ Permiso eliminado correctamente', 'success');
                    // Limpiar campo
                    document.getElementById('deleteValue').value = '';
                    
                    // Recargar la lista de permisos autom√°ticamente
                    setTimeout(() => {
                        getPermissions();
                    }, 500);
                    
                } else {
                    showToast(`‚ùå Error: ${data.error || 'Error desconocido'}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error al eliminar permiso:', error);
                
                // Mensajes espec√≠ficos seg√∫n el error
                if (error.message.includes('Failed to fetch')) {
                    showToast('üåê Error de conexi√≥n. Verifica que el servidor est√© activo.', 'error');
                } else if (error.message.includes('404')) {
                    showToast('üîç No se encontr√≥ el permiso. Verifica el email o ID.', 'warning');
                } else {
                    showToast(`‚ùå Error: ${error.message}`, 'error');
                }
                
            } finally {
                hideLoading();
            }
        }

        // Funci√≥n para cambiar el placeholder seg√∫n el tipo de eliminaci√≥n
        function toggleDeleteInput() {
            const deleteType = document.getElementById('deleteType').value;
            const deleteValueInput = document.getElementById('deleteValue');
            const deleteLabel = document.getElementById('deleteLabel');
            
            if (deleteType === 'email') {
                deleteLabel.textContent = 'Email del usuario';
                deleteValueInput.placeholder = 'usuario@gmail.com';
            } else {
                deleteLabel.textContent = 'ID del Permiso';
                deleteValueInput.placeholder = '15497558...';
            }
        }
    
        // Cargar tema guardado
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            
            const icon = document.querySelector('[onclick="toggleTheme()"] i');
            icon.className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }
        
        // Inicializar al cargar
        window.addEventListener('load', function() {
            loadTheme();
            checkConnection();
            
            // Verificar si hay ID en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const fileIdFromUrl = urlParams.get('file');
            if (fileIdFromUrl) {
                document.getElementById('fileId').value = fileIdFromUrl;
                document.getElementById('grantFileId').value = fileIdFromUrl;
            }
        });
    </script>
</body>
</html>
